window.Npw=window.Npw||{};(function(a,b,c){a.defaultAjaxFailureCallback=function(f){var d=f.status.toString();var e=d.length>0&&d[0]==="4";if(e){a.Controller.log("OFFLINE")}a.window.showOrHideOfflineError(e)};a.Controller=function(){};a.Controller.prototype.enable=function(f,e){a.Controller.log("Trying to enable chat");a.Utils.logAllProperties(f);if(a.state.chatStatus()!==a.ChatStatusTypes.RUNNING){var d=this;a.api.enable(function(k){a.Utils.logAllProperties(k);a.Utils.updateMonitoringStatus(e,k);if(k.available){a.Controller.log("Chat backend is available");a.state.chatStatus(a.ChatStatusTypes.ENABLED);var i=a.model.forceAutoOpen;var g=f&&f.autoOpenEnabled;var j=(i||g)&&a.model.timeToAutoOpenInSeconds>=0;a.Controller.log("Force auto open: "+i+", auto open enabled: "+g+", time to auto open in seconds: "+a.model.timeToAutoOpenInSeconds+", result: "+(j?"will":"won't")+" auto open");if(j){setTimeout(d.autoOpen,a.model.timeToAutoOpenInSeconds*1000)}}else{a.Controller.log("Chat backend is not available.");a.state.chatStatus(a.ChatStatusTypes.DISABLED);if(k.update.messages.length>0){var h=k.update.messages[0].text;a.window.setTitle(h)}}a.window.updateStatus(true);d.processUpdate(k.update)})}else{a.Controller.log("Chat already running")}};a.Controller.prototype.refresh=function(){a.Controller.log("Refreshing chat");a.api.refresh(a.state.lastMessageIndex(),this.processUpdate)};a.Controller.prototype.send=function(){a.Controller.log("Sending message");var e=b("#"+a.identifiers.getMessageTextAreaId());if(e.valid()){var f=e.val();var d=this;a.api.send(f,a.state.lastMessageIndex(),function(g){d.processUpdate(g)});e.val("")}else{a.Controller.log("Message not valid")}};a.Controller.prototype.finish=function(){a.Controller.log("Finishing chat");var d=this;a.api.finish(a.state.lastMessageIndex(),function(e){d.processUpdate(e)})};a.Controller.prototype.prepareStartOver=function(){a.Controller.log("Preparing start over");a.api.prepareStartOver();window.location=a.model.urls.startOver};a.Controller.prototype.startOver=function(){a.Controller.log("Starting chat over");a.state.chatStatus(a.ChatStatusTypes.ENABLED);a.controller.autoOpen();a.window.updateStatus(true)};a.Controller.prototype.close=function(){a.Controller.log("Closing chat");var d=this;a.api.close(function(e){d.processUpdate(e)});window.location=a.model.urls.reload};a.Controller.prototype.sendTranscript=function(){a.Controller.log("Sending transcript");var f=b("#"+a.identifiers.getEmailInputId());if(f.valid()){var e=f.val();var d=this;a.api.transcript(e,function(g){a.window.showEmailSendingConfirmation();d.processUpdate(g)},function(){a.window.showEmailSendingError()})}else{a.Controller.log("Email not valid")}};a.Controller.prototype.autoOpen=function(){if(a.state.chatStatus()===a.ChatStatusTypes.ENABLED){a.controller.expand(false)}};a.Controller.prototype.expandOrCollapse=function(){if(a.state.chatStatus()!==a.ChatStatusTypes.HIDDEN&&a.state.chatStatus()!==a.ChatStatusTypes.DISABLED){if(a.state.windowStatus()===a.WindowStatusTypes.COLLAPSED){a.controller.expand(true)}else{a.controller.collapse()}}};a.Controller.prototype.expand=function(e){if(a.state.windowStatus()!==a.WindowStatusTypes.EXPANDED){a.Controller.log("Expanding chat window");a.state.windowStatus(a.WindowStatusTypes.EXPANDED);a.window.updateStatus(true);var d=this;a.api.expand(e,function(f){d.processUpdate(f)})}};a.Controller.prototype.collapse=function(){if(a.state.windowStatus()!==a.WindowStatusTypes.COLLAPSED){a.Controller.log("Collapsing chat window");a.state.windowStatus(a.WindowStatusTypes.COLLAPSED);a.window.updateStatus(true);var d=this;a.api.collapse(function(e){d.processUpdate(e)})}};a.Controller.prototype.move=function(){a.Controller.log("Moving chat window");var d=a.window.positionAndSize();a.state.windowPositionAndSize(d)};a.Controller.prototype.resize=function(){a.Controller.log("Resizing chat window");var d=a.window.positionAndSize();a.state.windowPositionAndSize(d)};a.Controller.prototype.showHelp=function(){a.Controller.log("Showing help");a.state.helpStatus(a.HelpStatusTypes.VISIBLE);a.window.showHelp()};a.Controller.prototype.closeHelp=function(){a.Controller.log("Closing help");a.state.helpStatus(a.HelpStatusTypes.HIDDEN);a.window.closeHelp()};a.Controller.prototype.processUpdate=function(g){a.Controller.log("Status: "+g.status+", window status: "+g.windowStatus+", messages#: "+g.messages.length+", lastMessageIndex: "+g.lastMessageIndex);var d=g.status?a.ChatStatusTypes.fromCode(g.status):a.state.chatStatus();var f=g.windowStatus?a.WindowStatusTypes.fromCode(g.windowStatus):a.state.windowStatus();switch(d){case a.ChatStatusTypes.RUNNING:a.poller.start();break;case a.ChatStatusTypes.FINISHED:a.poller.stop();break;case a.ChatStatusTypes.ERROR:a.poller.stop();break;default:break}a.state.chatStatus(d);a.state.windowStatus(f);a.state.lastMessageIndex(g.lastMessageIndex);a.window.updateStatus(!a.state.movingOrResizing());var e=true;g.messages.forEach(function(i){var h=a.MessageTypes.fromCode(i.type);e=h!==a.MessageTypes.INCOMING_WARNING;a.window.addMessage(h,i.text,i.tooltip)});if(e){a.window.hideWarningMessage()}Npw.ChatMeasure.measure(g.measurement)};a.Controller.log=function(d){a.Utils.log("[Controller] "+d)};a.State=function(m,j,e,l,f){var i=m;var g=j;var o=e;var n=l;var d=f;var k=false;var h=false;var p={defaultPosition:true};this.chatStatus=function(q){if(typeof q==="undefined"){return i}else{if(i!==q){a.State.log("Chat status change: "+q.code);i=q}}};this.windowStatus=function(q){if(typeof q==="undefined"){return g}else{g=q}};this.helpStatus=function(q){if(typeof q==="undefined"){return o}else{o=q}};this.lastMessageIndex=function(q){if(typeof q==="undefined"){return n}else{n=q}};this.poller=function(q){if(typeof q==="undefined"){return d}else{d=q}};this.ignoreNextStatusBarClick=function(q){if(typeof q==="undefined"){return k}else{k=q}};this.movingOrResizing=function(q){if(typeof q==="undefined"){return h}else{h=q}};this.windowPositionAndSize=function(q){if(typeof q==="undefined"){return p}else{p=q}}};a.State.log=function(d){a.Utils.log("[State] "+d)};a.Poller=function(){};a.Poller.prototype.start=function(){if(!a.state.poller()){a.Poller.log("Starting polling");a.state.poller(true);this.poll()}};a.Poller.prototype.stop=function(){a.Poller.log("Stopping polling");a.state.poller(false)};a.Poller.prototype.poll=function(){var d=this;setTimeout(function(){a.controller.refresh();if(a.state.poller()){setTimeout(function(){d.poll()},a.model.pollingInterval)}},a.model.pollingInterval)};a.Poller.log=function(d){a.Utils.log("[Poller] "+d)}}(Npw.ChatKeeper=Npw.ChatKeeper||{},jQuery));